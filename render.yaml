# Render Infrastructure as Code
# Wix UCP Integration
# 
# Deploy: Connect GitHub repo to Render Dashboard
# Docs: https://render.com/docs/blueprint-spec

# ─────────────────────────────────────────────────────────────
# Web Service
# ─────────────────────────────────────────────────────────────
services:
  - type: web
    name: wix-ucp-api
    runtime: node
    region: oregon
    plan: starter
    
    # Build configuration
    buildCommand: |
      npm ci --include=dev
      npm run db:generate
      npm run db:migrate:deploy
      npm run build
    startCommand: npm run start
    
    # Health check
    healthCheckPath: /health
    
    # Auto-deploy from main branch
    autoDeploy: true
    
    # Environment variables
    envVars:
      # Node environment
      - key: NODE_ENV
        value: production
      
      # Server config
      - key: PORT
        value: 3000
      
      # Database connection (from Render PostgreSQL)
      - key: DATABASE_URL
        fromDatabase:
          name: wix-ucp-db
          property: connectionString
      
      # Redis connection (from Render Redis)
      - key: REDIS_URL
        fromService:
          name: wix-ucp-redis
          type: redis
          property: connectionString
      
      # UCP Configuration
      - key: UCP_VERSION
        value: "2026-01-11"
      - key: UCP_HANDLER_ID
        value: com.wix.payments
      
      # Logging
      - key: LOG_LEVEL
        value: info
      
      # Secrets (set manually in Render Dashboard)
      # - JWT_SECRET
      # - WIX_API_KEY
      # - WIX_ACCOUNT_ID
      # - WIX_SITE_ID
      # - WEBHOOK_SECRET

  # ─────────────────────────────────────────────────────────────
  # Redis (Key-Value Store)
  # ─────────────────────────────────────────────────────────────
  - type: redis
    name: wix-ucp-redis
    region: oregon
    plan: starter
    
    # Eviction policy for cache
    maxmemoryPolicy: allkeys-lru
    
    # IP allow list (optional, for security)
    # ipAllowList: []

# ─────────────────────────────────────────────────────────────
# PostgreSQL Database
# ─────────────────────────────────────────────────────────────
databases:
  - name: wix-ucp-db
    region: oregon
    plan: starter
    
    # PostgreSQL version
    postgresMajorVersion: 16
    
    # Database name
    databaseName: wix_ucp
    
    # User
    user: wix_ucp_user
    
    # IP allow list (optional)
    # ipAllowList:
    #   - source: 0.0.0.0/0
    #     description: Allow all (use with caution)
